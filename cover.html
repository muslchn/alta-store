
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>config: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">alta-store/config/config.go (91.7%)</option>
				
				<option value="file1">alta-store/controller/cartController.go (0.0%)</option>
				
				<option value="file2">alta-store/controller/categoryController.go (0.0%)</option>
				
				<option value="file3">alta-store/controller/checkoutController.go (0.0%)</option>
				
				<option value="file4">alta-store/controller/customerController.go (0.0%)</option>
				
				<option value="file5">alta-store/controller/paymentController.go (0.0%)</option>
				
				<option value="file6">alta-store/controller/productController.go (81.8%)</option>
				
				<option value="file7">alta-store/controller/welcomeController.go (0.0%)</option>
				
				<option value="file8">alta-store/lib/database/dbCart.go (0.0%)</option>
				
				<option value="file9">alta-store/lib/database/dbCategory.go (0.0%)</option>
				
				<option value="file10">alta-store/lib/database/dbCheckout.go (0.0%)</option>
				
				<option value="file11">alta-store/lib/database/dbCustomer.go (0.0%)</option>
				
				<option value="file12">alta-store/lib/database/dbInit.go (0.0%)</option>
				
				<option value="file13">alta-store/lib/database/dbPayment.go (0.0%)</option>
				
				<option value="file14">alta-store/lib/database/dbProduct.go (31.0%)</option>
				
				<option value="file15">alta-store/main.go (0.0%)</option>
				
				<option value="file16">alta-store/middleware/jwtMiddleware.go (0.0%)</option>
				
				<option value="file17">alta-store/route/route.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package config

import (
        "alta-store/model"
        "alta-store/secret"
        "fmt"

        "gorm.io/driver/mysql"
        "gorm.io/gorm"
)

var DB *gorm.DB

func InitDB() <span class="cov8" title="1">{
        config := map[string]string{
                "DB_Username": "root",
                "DB_Password": secret.DB_PASSWORD,
                "DB_Port":     "3306",
                "DB_Host":     "localhost",
                "DB_Name":     "alta-store",
        }

        connectionString := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=utf8&amp;parseTime=True&amp;loc=Local",
                config["DB_Username"],
                config["DB_Password"],
                config["DB_Host"],
                config["DB_Port"],
                config["DB_Name"],
        )

        var err error
        DB, err = gorm.Open(mysql.Open(connectionString), &amp;gorm.Config{})
        if err != nil </span><span class="cov0" title="0">{
                panic(err)</span>
        }

        <span class="cov8" title="1">InitMigrate()</span>
}

func InitMigrate() <span class="cov8" title="1">{
        DB.AutoMigrate(&amp;model.Cart{})
        DB.AutoMigrate(&amp;model.Category{})
        DB.AutoMigrate(&amp;model.Customer{})
        DB.AutoMigrate(&amp;model.Payment{})
        DB.AutoMigrate(&amp;model.Product{})
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/middleware"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func AddCartItemController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        item := make(map[string]string)
        item["productId"] = c.FormValue("productId")
        item["qty"] = c.FormValue("qty")
        validation, cartItem, err := database.AddCartItem(item, uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusBadRequest, err.Error())
        }</span>

        <span class="cov0" title="0">if !validation[0] </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "product not found",
                })
        }</span> else<span class="cov0" title="0"> if !validation[1] </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "product out of stock",
                })
        }</span> else<span class="cov0" title="0"> if !validation[2] </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "product is less than you want to take",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusCreated, model.Response{
                Status:  "ok",
                Message: "success add item to cart",
                Data:    cartItem,
        })</span>
}

func GetCartController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        cart, err := database.GetCart(uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusBadRequest, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get cart",
                Data:    cart,
        })</span>
}

func DeleteCartItemController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        cartItemId, _ := strconv.Atoi(c.Param("id"))
        validate, validateItem, err := database.ValidateCartItem(uint(cartItemId), uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusBadRequest, err.Error())
        }</span>

        <span class="cov0" title="0">if !validate </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "item not found",
                })
        }</span>

        <span class="cov0" title="0">database.ReturnStock(validateItem["productId"], validateItem["qty"])
        database.DeleteCartItem(uint(cartItemId))

        return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "item removed",
        })</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func GetCategoryController(c echo.Context) error <span class="cov0" title="0">{
        category, err := database.GetCategory()

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get categories",
                Data:    category,
        })</span>
}

func GetCategoryByIdController(c echo.Context) error <span class="cov0" title="0">{
        id, _ := strconv.Atoi(c.Param("id"))
        category, err := database.GetCategoryById(uint(id))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">if category == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "category not found",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get category",
                Data:    category,
        })</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/middleware"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func CheckoutController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        cartId, _ := database.CartCheck(uint(customerId))
        totalItem, totalPrice, err := database.GetTotal(uint(cartId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">checkout, err := database.CreateCheckout(uint(customerId), uint(cartId), totalItem, totalPrice)

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">database.ChangeCartStatus(uint(cartId))

        return c.JSON(http.StatusCreated, model.Response{
                Status:  "ok",
                Message: "success checkout",
                Data:    checkout,
        })</span>
}

func GetCheckoutController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        checkout, err := database.GetCheckout(uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get checkout(s)",
                Data:    checkout,
        })</span>
}

func GetCheckoutByIdController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        id, _ := strconv.Atoi(c.Param("id"))
        checkout, err := database.GetCheckoutById(uint(id), uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">if checkout == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "checkout data not found",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get checkout data",
                Data:    checkout,
        })</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func RegisterController(c echo.Context) error <span class="cov0" title="0">{
        // // get data form value
        // firstName := c.FormValue("firstName")
        // lastName := c.FormValue("lastName")
        // username := c.FormValue("username")
        // email := c.FormValue("email")
        // password := c.FormValue("password")
        // phone := c.FormValue("phone")
        // address := c.FormValue("address")
        // city := c.FormValue("city")
        // state := c.FormValue("state")
        // postalCode := c.FormValue("postalCode")

        // var customer model.Customer
        // customer.FirstName = firstName
        // customer.LastName = lastName
        // customer.Username = username
        // customer.Email = email
        // customer.Password = password
        // customer.Phone = phone
        // customer.Address = address
        // customer.City = city
        // customer.State = state
        // customer.PostalCode = postalCode

        // binding data
        var customer model.Customer
        c.Bind(&amp;customer)
        register, err := database.Register(&amp;customer)

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusCreated, model.Response{
                Status:  "ok",
                Message: "register succeed",
                Data:    register,
        })</span>
}

func LoginController(c echo.Context) error <span class="cov0" title="0">{
        type dataModel struct {
                email string
                token string
        }

        email := c.FormValue("email")
        password := c.FormValue("password")

        customer, name, token, err := database.Login(email, password)

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">if customer == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "account not found or password incorrect",
                })
        }</span>

        <span class="cov0" title="0">hello := "hello" + name

        data := dataModel{
                email: email,
                token: token,
        }

        return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: hello,
                Data:    data,
        })</span>
}

func GetCustomerDetailController(c echo.Context) error <span class="cov0" title="0">{
        id, _ := strconv.Atoi(c.Param("id"))
        customer, err := database.GetDetailCustomer(id)

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusBadRequest, err.Error())
        }</span>

        <span class="cov0" title="0">if customer == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "data not found",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get customer detail",
                Data:    customer,
        })</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/middleware"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func PaymentController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        checkoutId, _ := strconv.Atoi(c.FormValue("checkoutId"))
        payment, err := database.Payment(uint(customerId), uint(checkoutId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">if payment == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "checkout data not found",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusCreated, model.Response{
                Status:  "ok",
                Message: "payment success",
                Data:    payment,
        })</span>
}

func LastPaymentController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        lastPayment, err := database.LastPayment(uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get last payment",
                Data:    lastPayment,
        })</span>
}

func PaymentHistoryController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        paymentHistory, err := database.PaymentHistory(uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get payment history(s)",
                Data:    paymentHistory,
        })</span>
}

func PaymentByIdController(c echo.Context) error <span class="cov0" title="0">{
        customerId := middleware.ExtractTokenCustomerId(c)
        id, _ := strconv.Atoi(c.Param("id"))
        paymentById, err := database.PaymentById(uint(id), uint(customerId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov0" title="0">if paymentById == nil </span><span class="cov0" title="0">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "data not found",
                })
        }</span>

        <span class="cov0" title="0">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get payment history",
                Data:    paymentById,
        })</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package controller

import (
        "alta-store/lib/database"
        "alta-store/model"
        "net/http"
        "strconv"

        "github.com/labstack/echo/v4"
)

func GetProductsController(c echo.Context) error <span class="cov8" title="1">{
        products, err := database.GetProducts()

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov8" title="1">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get products",
                Data:    products,
        })</span>
}

func GetProductsByCategoryController(c echo.Context) error <span class="cov8" title="1">{
        categoryId, _ := strconv.Atoi(c.QueryParam("category"))

        products, err := database.GetProductsByCategory(uint(categoryId))

        if err != nil </span><span class="cov0" title="0">{
                return echo.NewHTTPError(http.StatusInternalServerError, err.Error())
        }</span>

        <span class="cov8" title="1">if products == nil </span><span class="cov8" title="1">{
                return c.JSON(http.StatusBadRequest, model.Response{
                        Status:  "fail",
                        Message: "category not found",
                })
        }</span>

        <span class="cov8" title="1">return c.JSON(http.StatusOK, model.Response{
                Status:  "ok",
                Message: "success get products",
                Data:    products,
        })</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package controller

import (
        "net/http"

        "github.com/labstack/echo/v4"
)

func WelcomeController(c echo.Context) error <span class="cov0" title="0">{
        return c.String(http.StatusOK, "Welcome to ALTA STORE\nHappy Shopping :)")
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
        "strconv"
)

func GetCart(customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var cartItem []model.CartItem
        cartId, _ := CartCheck(customerId)

        if err := config.DB.Where("cart_id = ?", cartId).Find(&amp;cartItem).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return cartItem, nil</span>
}

func CartCheck(customerId uint) (uint, error) <span class="cov0" title="0">{
        var cart model.Cart

        query := config.DB.Where("customer_id = ? AND checkout = false", customerId).Find(&amp;cart)

        if query.Error != nil </span><span class="cov0" title="0">{
                return 0, query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                cart = model.Cart{
                        CustomerID: customerId,
                        Checkout:   false,
                }

                config.DB.Create(&amp;cart)
                CartCheck(customerId)
        }</span>

        <span class="cov0" title="0">return cart.ID, nil</span>
}

func AddCartItem(item map[string]string, customerId uint) ([]bool, interface{}, error) <span class="cov0" title="0">{
        // type productResponse struct {
        //         Product bool
        //         Stock   bool
        //         Qty     bool
        // }

        productRes := []bool{false, false, false}

        cartId, _ := CartCheck(customerId)
        productId, _ := strconv.Atoi(item["product_id"])
        productValidation, productStock, productPrice, err := GetProductById(uint(productId))
        qty, _ := strconv.Atoi(item["qty"])
        total := productPrice * uint(qty)

        if err != nil </span><span class="cov0" title="0">{
                return nil, nil, err
        }</span>

        <span class="cov0" title="0">if !productValidation </span><span class="cov0" title="0">{
                return productRes, nil, nil
        }</span>

        <span class="cov0" title="0">if productStock == 0 </span><span class="cov0" title="0">{
                productRes[0] = true

                return productRes, nil, nil
        }</span>

        <span class="cov0" title="0">if productStock &lt; uint(qty) </span><span class="cov0" title="0">{
                productRes[0] = true
                productRes[1] = true

                return productRes, nil, nil
        }</span>

        <span class="cov0" title="0">cartItem := model.CartItem{
                CartID:    cartId,
                ProductID: uint(productId),
                Price:     productPrice,
                Qty:       uint(qty),
                Total:     total,
        }

        if err := config.DB.Create(&amp;cartItem).Error; err != nil </span><span class="cov0" title="0">{
                return nil, nil, err
        }</span>

        <span class="cov0" title="0">UpdateProductStockById(uint(productId), productStock, uint(qty))

        return nil, cartItem, nil</span>
}

func ValidateCartItem(cartItemId, customerId uint) (bool, map[string]uint, error) <span class="cov0" title="0">{
        var cartItem model.CartItem

        cartId, _ := CartCheck(customerId)
        query := config.DB.Where("id = ? AND cart_id = ?", cartItemId, cartId).Find(&amp;cartItem)
        returnItem := make(map[string]uint)

        if query.Error != nil </span><span class="cov0" title="0">{
                return false, nil, query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                return false, nil, nil
        }</span>

        <span class="cov0" title="0">returnItem["productId"] = cartItem.ProductID
        returnItem["qty"] = cartItem.Qty

        return true, returnItem, nil</span>
}

func DeleteCartItem(id uint) (interface{}, error) <span class="cov0" title="0">{
        var cartItem model.CartItem

        if err := config.DB.Where("id = ?", id).Delete(&amp;cartItem).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return true, nil</span>
}

func ChangeCartStatus(id uint) error <span class="cov0" title="0">{
        cart := model.Cart{
                Checkout: true,
        }

        if err := config.DB.Where("id = ?", id).Updates(&amp;cart).Error; err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
)

func GetCategory() (interface{}, error) <span class="cov0" title="0">{
        var category []model.Category

        if err := config.DB.Find(&amp;category).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return category, nil</span>
}

func GetCategoryById(id uint) (interface{}, error) <span class="cov0" title="0">{
        var category model.Category

        if err := config.DB.Where("id = ?", id).Find(&amp;category).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return category, nil</span>
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
)

func GetTotal(cartId uint) (uint, uint, error) <span class="cov0" title="0">{
        var (
                cartItems  []model.CartItem
                totalItem  uint
                totalPrice uint
        )

        if err := config.DB.Where("cart_id = ?", cartId).Find(&amp;cartItems).Error; err != nil </span><span class="cov0" title="0">{
                return 0, 0, err
        }</span>

        <span class="cov0" title="0">for _, item := range cartItems </span><span class="cov0" title="0">{
                totalItem += item.Qty
                totalPrice += item.Total
        }</span>

        <span class="cov0" title="0">return totalItem, totalPrice, nil</span>
}

func CreateCheckout(customerId, cartId, totalItem, totalPrice uint) (interface{}, error) <span class="cov0" title="0">{
        // var cart model.Cart

        // if err := config.DB.Where("id = ?", cartId).Find(&amp;cart).Error; err != nil {
        //         return nil, err
        // }

        // customerId := cart.CustomerID

        checkout := model.Checkout{
                CustomerID: customerId,
                CartID:     cartId,
                TotalItem:  totalItem,
                TotalPrice: totalPrice,
                Paid:       false,
        }

        if err := config.DB.Create(&amp;checkout).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return checkout, nil</span>
}

func GetCheckout(customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var checkout []model.Checkout

        if err := config.DB.Where("customer_id = ? AND paid = false", customerId).Find(&amp;checkout).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return checkout, nil</span>
}

func GetCheckoutById(id, customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var checkout model.Checkout

        query := config.DB.Where("id = ? AND customer_id = ?", id, customerId).First(&amp;checkout)

        if query.Error != nil </span><span class="cov0" title="0">{
                return nil, query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov0" title="0">return checkout, nil</span>
}

func EditCheckoutStatus(id uint) error <span class="cov0" title="0">{
        var checkout = model.Checkout{
                Paid: true,
        }

        if err := config.DB.Where("id = ?", id).Updates(&amp;checkout).Error; err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file11" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/middleware"
        "alta-store/model"
)

func Register(getCustomer *model.Customer) (interface{}, error) <span class="cov0" title="0">{

        customer := *getCustomer

        if err := config.DB.Create(&amp;customer).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return customer, nil</span>
}

func GetDetailCustomer(id int) (interface{}, error) <span class="cov0" title="0">{
        var customer model.Customer

        if err := config.DB.Find(&amp;customer, "id = ?", id).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return customer, nil</span>
}

func Login(email, password string) (interface{}, string, string, error) <span class="cov0" title="0">{
        var customer model.Customer

        if err := config.DB.Where("email = ? AND password = ?", email, password).First(&amp;customer).Error; err != nil </span><span class="cov0" title="0">{
                return nil, "", "", err
        }</span>

        <span class="cov0" title="0">token, err := middleware.CreateToken(int(customer.ID))

        if err != nil </span><span class="cov0" title="0">{
                return nil, "", "", err
        }</span>

        <span class="cov0" title="0">customer.Token = token

        if err := config.DB.Save(&amp;customer).Error; err != nil </span><span class="cov0" title="0">{
                return nil, "", "", err
        }</span>

        <span class="cov0" title="0">return customer, customer.FirstName, customer.Token, nil</span>
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
)

func InitData() <span class="cov0" title="0">{
        var (
                category []model.Category
                product  []model.Product
        )

        if query := config.DB.Find(&amp;category); query.RowsAffected == 0 </span><span class="cov0" title="0">{
                category = []model.Category{
                        {Name: "Buku"},
                        {Name: "Handphone"},
                        {Name: "Laptop"},
                }

                config.DB.Create(&amp;category)
        }</span>

        <span class="cov0" title="0">if query := config.DB.Find(&amp;product); query.RowsAffected == 0 </span><span class="cov0" title="0">{
                product = []model.Product{
                        {
                                CategoryID:  1,
                                Name:        "Sapiens",
                                Description: "Riwayat Singkat Umat Manusia ...",
                                Stock:       3,
                                Price:       115000,
                                Weight:      700,
                        },

                        {
                                CategoryID:  1,
                                Name:        "Disruption",
                                Description: "Disruptive Innovation ...",
                                Stock:       3,
                                Price:       116900,
                                Weight:      500,
                        },

                        {
                                CategoryID:  1,
                                Name:        "Atomic Habits",
                                Description: "Perubahan Kecil Yang Memberikan Hasil Luar Biasa ...",
                                Stock:       3,
                                Price:       86500,
                                Weight:      500,
                        },

                        {
                                CategoryID:  2,
                                Name:        "iPhone 12 128GB",
                                Description: "Garansi Resmi iBox Apple Indonesia ...",
                                Stock:       3,
                                Price:       13950000,
                                Weight:      500,
                        },

                        {
                                CategoryID:  2,
                                Name:        "Samsung Galaxy A12 128GB",
                                Description: "PLATFORM OS Android 10 ...",
                                Stock:       3,
                                Price:       2254000,
                                Weight:      500,
                        },

                        {
                                CategoryID:  2,
                                Name:        "Oppo Reno6 128GB",
                                Description: "Garansi Resmi Oppo 1 Tahun ...",
                                Stock:       3,
                                Price:       4405000,
                                Weight:      500,
                        },

                        {
                                CategoryID:  3,
                                Name:        "MacBook Air M1",
                                Description: "Macbook Terbaik ...",
                                Stock:       3,
                                Price:       15990000,
                                Weight:      5000,
                        },

                        {
                                CategoryID:  3,
                                Name:        "ASUS ROG Zephyrus G15",
                                Description: "Laptop Gaming Terbaik ...",
                                Stock:       3,
                                Price:       32999000,
                                Weight:      6000,
                        },

                        {
                                CategoryID:  3,
                                Name:        "Acer Swift 3 Infinity 4",
                                Description: "Laptop untuk Mahasiswa ...",
                                Stock:       3,
                                Price:       12499000,
                                Weight:      5000,
                        },
                }

                config.DB.Create(&amp;product)
        }</span>
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
)

func Payment(customerId, checkoutId uint) (interface{}, error) <span class="cov0" title="0">{
        var (
                checkout model.Checkout
                payment  model.Payment
                paid     uint
        )

        query := config.DB.Where("id = ? AND customer_id = ? AND paid = false", checkoutId, customerId).First(&amp;checkout)

        if query.Error != nil </span><span class="cov0" title="0">{
                return nil, query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov0" title="0">paid = checkout.TotalPrice

        payment = model.Payment{
                CustomerID: customerId,
                CheckoutID: checkoutId,
                Paid:       paid,
        }

        if err := config.DB.Create(&amp;payment).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">EditCheckoutStatus(checkoutId)

        return payment, nil</span>
}

func LastPayment(customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var lastPayment model.Payment

        if err := config.DB.Where("customer_id = ?", customerId).Last(&amp;lastPayment).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return lastPayment, nil</span>
}

func PaymentHistory(customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var paymentHistory []model.Payment

        if err := config.DB.Where("customer_id = ?", customerId).Find(&amp;paymentHistory).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return paymentHistory, nil</span>
}

func PaymentById(id, customerId uint) (interface{}, error) <span class="cov0" title="0">{
        var paymentById model.Payment

        query := config.DB.Where("id = ? AND customer_id = ?", id, customerId).First(&amp;paymentById)

        if query.Error != nil </span><span class="cov0" title="0">{
                return nil, query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov0" title="0">return paymentById, nil</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package database

import (
        "alta-store/config"
        "alta-store/model"
)

func GetProducts() (interface{}, error) <span class="cov8" title="1">{
        var products []model.Product

        if err := config.DB.Find(&amp;products).Error; err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return products, nil</span>
}

func GetProductsByCategory(categoryId uint) (interface{}, error) <span class="cov8" title="1">{
        var products []model.Product

        query := config.DB.Where("category_id  = ?", categoryId).Find(&amp;products)

        if query.Error != nil </span><span class="cov0" title="0">{
                return nil, query.Error
        }</span>

        <span class="cov8" title="1">if query.RowsAffected == 0 </span><span class="cov8" title="1">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">return products, nil</span>
}

func GetProductById(id uint) (bool, uint, uint, error) <span class="cov0" title="0">{
        var product model.Product

        query := config.DB.Where("id = ?", id).Find(&amp;product)

        if err := query.Error; err != nil </span><span class="cov0" title="0">{
                return false, 0, 0, err
        }</span>

        <span class="cov0" title="0">if query.RowsAffected == 0 </span><span class="cov0" title="0">{
                return false, 0, 0, nil
        }</span>

        <span class="cov0" title="0">return true, product.Stock, product.Price, nil</span>
}

func UpdateProductStockById(id, stock, qty uint) <span class="cov0" title="0">{
        product := model.Product{
                Stock: stock - qty,
        }

        config.DB.Where("product_id = ?", id).Updates(&amp;product)
}</span>

func ReturnStock(productId, qty uint) error <span class="cov0" title="0">{
        var (
                product model.Product
                stock   uint
        )

        query := config.DB.Where("id = ?", productId).First(&amp;product)

        if query.Error != nil </span><span class="cov0" title="0">{
                return query.Error
        }</span>

        <span class="cov0" title="0">if query.RowsAffected != 0 </span><span class="cov0" title="0">{
                stock = product.Stock
                returnStock := model.Product{
                        Stock: stock + qty,
                }

                config.DB.Where("id = ?", productId).Updates(&amp;returnStock)
        }</span>

        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package main

import (
        "alta-store/config"
        "alta-store/lib/database"
        routes "alta-store/route"
)

func main() <span class="cov0" title="0">{
        config.InitDB()
        database.InitData()
        e := routes.New()
        e.Logger.Fatal(e.Start(":8000"))
}</span>
</pre>
		
		<pre class="file" id="file16" style="display: none">package middleware

import (
        "alta-store/secret"
        "time"

        "github.com/golang-jwt/jwt"
        "github.com/labstack/echo/v4"
)

func CreateToken(customerId int) (string, error) <span class="cov0" title="0">{
        claims := jwt.MapClaims{}
        claims["authorized"] = true
        claims["customerId"] = customerId
        claims["exp"] = time.Now().Add(time.Hour * 1).Unix()

        token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
        return token.SignedString([]byte(secret.SECRET_JWT))
}</span>

func ExtractTokenCustomerId(e echo.Context) int <span class="cov0" title="0">{
        customer := e.Get("customer").(*jwt.Token)
        if customer.Valid </span><span class="cov0" title="0">{
                claims := customer.Claims.(jwt.MapClaims)
                customerId := int(claims["customerId"].(float64))
                return customerId
        }</span>
        <span class="cov0" title="0">return 0</span>
}
</pre>
		
		<pre class="file" id="file17" style="display: none">package route

import (
        "alta-store/controller"
        "alta-store/secret"

        "github.com/labstack/echo/v4"
        "github.com/labstack/echo/v4/middleware"
)

func New() *echo.Echo <span class="cov0" title="0">{
        e := echo.New()

        // Welcome
        e.GET("", controller.WelcomeController)
        e.GET("/welcome", controller.WelcomeController)

        // Products
        e.GET("/products", controller.GetProductsController)
        e.GET("/products", controller.GetProductsByCategoryController)

        // Category
        e.GET("/category", controller.GetCategoryController)
        e.GET("/category/:id", controller.GetCategoryByIdController)

        // Customer Authentication
        e.POST("/register", controller.RegisterController)
        e.POST("/login", controller.LoginController)

        // JWT Group
        r := e.Group("")
        r.Use(middleware.JWT([]byte(secret.SECRET_JWT)))

        // Customer Auth
        r.GET("/customers/:id", controller.GetCustomerDetailController)

        // Cart
        r.POST("/carts", controller.AddCartItemController)
        r.GET("/carts", controller.GetCartController)
        r.DELETE("/carts/:id", controller.DeleteCartItemController)

        // Checkout
        r.POST("/checkout", controller.CheckoutController)
        r.GET("/checkout", controller.GetCheckoutController)
        r.GET("/checkout/:id", controller.GetCheckoutByIdController)

        // Payment
        r.POST("/payment", controller.PaymentController)
        r.GET("/payment/last", controller.LastPaymentController)
        r.GET("/payment", controller.PaymentHistoryController)
        r.GET("/payment/:id", controller.PaymentByIdController)

        return e
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
